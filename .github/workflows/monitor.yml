name: ä¸œæ¨ªInn ç›‘æ§ (v25.0 æ™ºèƒ½å…³è”ç‰ˆ)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      - name: ç”Ÿæˆå¹¶è¿è¡Œè„šæœ¬
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          cat << 'EOF' > monitor.py
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs, unquote
          import json
          import re
          from datetime import datetime, timedelta, timezone

          # === 1. æ—¶é—´æ§åˆ¶å™¨ ===
          try:
              tz_beijing = timezone(timedelta(hours=8))
              now = datetime.now(tz_beijing)
              if os.path.exists('run_time.txt'):
                  with open('run_time.txt', 'r') as f:
                      content = f.read().strip()
                      if '-' in content:
                          s, e = map(int, content.split('-'))
                          h = now.hour
                          is_run = (s <= h <= e) if s <= e else (h >= s or h <= e)
                          if not is_run:
                              print(f'ğŸ’¤ ä¼‘çœ æ—¶é—´ ({s}-{e})ï¼Œå½“å‰ {h} ç‚¹ã€‚')
                              exit(0)
          except: pass

          # === 2. åŸºç¡€é…ç½® ===
          resend.api_key = os.environ.get('RESEND_API_KEY')
          user_email = os.environ.get('USER_EMAIL', '').strip()
          
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
              'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
              'Referer': 'https://www.toyoko-inn.com/china_cn/',
              'Connection': 'keep-alive',
          }

          urls = []
          try:
              with open('urls.txt', 'r') as f:
                  for line in f:
                      line = line.strip()
                      if line and not line.startswith('#'):
                          urls.append(line)
          except:
              print('âŒ æ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'\nğŸ“‹ å¯åŠ¨ç›‘æ§: {len(urls)} ä¸ªä»»åŠ¡ (v25.0 æ™ºèƒ½å…³è”ç‰ˆ)\n')
          
          session = requests.Session()
          session.headers.update(headers)
          
          try: session.get('https://www.toyoko-inn.com/china_cn/', timeout=5)
          except: pass

          found_list = []

          for i, url in enumerate(urls):
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  checkin_date = params.get('start', ['æœªçŸ¥'])[0]
                  
                  max_price = 999999
                  if 'max' in params:
                      try: max_price = int(params['max'][0])
                      except: pass
                  
                  target_room = None
                  if 'roomtype' in params: target_room = unquote(params['roomtype'][0])
                  
                  target_smoke = None 
                  if 'smoke' in params:
                      val = params['smoke'][0]
                      if val == '1': target_smoke = True
                      elif val == '0': target_smoke = False
              except:
                  hotel_id, checkin_date = 'æœªçŸ¥', 'æœªçŸ¥'
                  max_price = 999999
                  target_room, target_smoke = None, None

              print(f'[{i+1}/{len(urls)}] ğŸ¨ {hotel_id} | ğŸ“… {checkin_date}')

              detailed_rooms = [] 
              final_hotel_name = f"é…’åº—{hotel_id}"

              try:
                  resp = session.get(url, timeout=30)
                  soup = BeautifulSoup(resp.text, 'html.parser')
                  
                  # æŠ“å–é…’åº—å
                  try:
                      h1 = soup.find('h1')
                      if h1:
                          final_hotel_name = h1.get_text(strip=True).replace('é€‰æ‹©å¥—é¤', '').replace('ä¸œæ¨ªINN', '').strip()
                          final_hotel_name = f"ä¸œæ¨ªINN {final_hotel_name}"
                  except: pass

                  # === å¼•æ“ A: JSON è§£æ (é¦–é€‰) ===
                  json_success = False
                  if '__NEXT_DATA__' in resp.text:
                      try:
                          script = soup.find('script', id='__NEXT_DATA__')
                          data = json.loads(script.string)
                          room_plan_list = data.get('props', {}).get('pageProps', {}).get('roomPlanList', [])
                          
                          if room_plan_list:
                              for plan in room_plan_list:
                                  for room in plan.get('roomTypes', []):
                                      r_name = room.get('roomTypeName', '')
                                      is_smoking = room.get('specs', {}).get('isSmoking', False)
                                      stock = room.get('vacant', {}).get('generalVacantRoom', 0)
                                      if stock is None: stock = 0
                                      price = room.get('price', {}).get('generalPrice', 999999)
                                      
                                      if stock <= 0: continue
                                      if price > max_price: continue
                                      if target_room and target_room not in r_name: continue
                                      if target_smoke is not None and target_smoke != is_smoking: continue
                                      
                                      smoke_str = 'å¸çƒŸ' if is_smoking else 'ç¦çƒŸ'
                                      detailed_rooms.append({
                                          'name': r_name,
                                          'smoke': smoke_str,
                                          'price': price,
                                          'stock': stock,
                                          'source': 'json'
                                      })
                              json_success = True
                      except: pass

                  # === å¼•æ“ B: æ™ºèƒ½DOMæ‰«æ (å…œåº•) ===
                  # å½“ JSON å¤±è´¥æˆ–ä¸ºç©ºæ—¶ï¼Œå°è¯•ä» HTML ç»“æ„ä¸­â€œæŠ â€å‡ºæˆ¿å‹å’Œä»·æ ¼çš„å¯¹åº”å…³ç³»
                  if not detailed_rooms:
                      # æ‰¾åˆ°æ‰€æœ‰ä»·æ ¼æ ‡ç­¾
                      # ä»·æ ¼é€šå¸¸æ˜¯: Â¥ 8,740 è¿™æ ·çš„æ ¼å¼
                      price_nodes = soup.find_all(string=re.compile(r'Â¥\s*[0-9,]+'))
                      
                      for node in price_nodes:
                          try:
                              p_str = node.strip().replace(',', '').replace('Â¥', '').strip()
                              price = int(p_str)
                              
                              # æ’é™¤æ‚è´¹
                              if price < 4000 or price == 10000: continue
                              if price > max_price: continue

                              # === ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šå‘ä¸Šæ‰¾æˆ¿å‹ ===
                              # æˆ‘ä»¬å‘ä¸Šå›æº¯ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªåŒ…å«"æˆ¿"å­—æˆ–è€…"Room"å­—çš„çˆ¶çº§å®¹å™¨
                              # æˆ–è€…å›æº¯å›ºå®šå±‚çº§(æ¯”å¦‚4å±‚)ï¼Œåœ¨è¯¥èŒƒå›´å†…æ‰¾æˆ¿å‹å
                              
                              container = node.parent
                              found_name = "æœªçŸ¥æˆ¿å‹"
                              found_smoke = "æœªçŸ¥"
                              
                              # å‘ä¸Šæ‰¾ 4 å±‚
                              for _ in range(4):
                                  if container is None: break
                                  
                                  # åœ¨è¿™ä¸ªå®¹å™¨é‡Œæ‰¾æˆ¿å‹å
                                  # ç­–ç•¥ï¼šæ‰¾é™¤äº†ä»·æ ¼ä¹‹å¤–ï¼Œæœ€åƒæ ‡é¢˜çš„æ–‡æœ¬
                                  # æ’é™¤æ‰ "å‰©Xé—´", "è¯¦æƒ…", "æ ‡å‡†å¥—é¤" ç­‰å™ªéŸ³
                                  text_content = container.get_text(" ", strip=True)
                                  
                                  # 1. æ‰¾å¸çƒŸ/ç¦çƒŸ
                                  if "å¸çƒŸ" in text_content: found_smoke = "å¸çƒŸ"
                                  elif "ç¦çƒŸ" in text_content: found_smoke = "ç¦çƒŸ"
                                  
                                  # 2. æ‰¾æˆ¿å‹å (å°è¯•æ‰¾ h2, h3, h4, h5 æˆ–ç‰¹å®šclass)
                                  # å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±å°è¯•æ‰¾åŒ…å« "æˆ¿" çš„çŸ­è¯­
                                  name_candidates = container.find_all(string=re.compile(r'å•äºº|åŒäºº|åŒåºŠ|è±ªå|ç»æµ|åšçˆ±|æˆ¿'))
                                  for nc in name_candidates:
                                      n_str = nc.strip()
                                      if len(n_str) < 15 and "Â¥" not in n_str and "å‰©" not in n_str:
                                          found_name = n_str
                                          break
                                  
                                  if found_name != "æœªçŸ¥æˆ¿å‹": break
                                  container = container.parent

                              # ç­›é€‰æ¡ä»¶æ£€æŸ¥ (æ–‡æœ¬æ¨¡å¼ä¹Ÿæ”¯æŒç­›é€‰)
                              if target_room and target_room not in found_name: continue
                              if target_smoke is True and found_smoke == "ç¦çƒŸ": continue
                              if target_smoke is False and found_smoke == "å¸çƒŸ": continue

                              detailed_rooms.append({
                                  'name': found_name,
                                  'smoke': found_smoke,
                                  'price': price,
                                  'stock': 'æœªçŸ¥(æ–‡æœ¬)',
                                  'source': 'text'
                              })
                          except: pass

                  # å»é‡ (æ–‡æœ¬æ¨¡å¼å¯èƒ½ä¼šæŠ“åˆ°é‡å¤çš„)
                  unique_rooms = {}
                  for r in detailed_rooms:
                      key = f"{r['name']}-{r['smoke']}-{r['price']}"
                      if key not in unique_rooms:
                          unique_rooms[key] = r
                  detailed_rooms = list(unique_rooms.values())

                  # === ç»“æœå¤„ç† ===
                  if detailed_rooms:
                      # æ’åºï¼šä»·æ ¼ä»ä½åˆ°é«˜
                      detailed_rooms.sort(key=lambda x: x['price'])
                      best = detailed_rooms[0]
                      
                      print(f'      ğŸ‰ å‘ç° {len(detailed_rooms)} ä¸ªæˆ¿å‹! æœ€ä½: {best["name"]} Â¥{best["price"]}')
                      
                      found_list.append({
                          'name': final_hotel_name,
                          'date': checkin_date,
                          'url': url,
                          'price': best['price'],
                          'details': detailed_rooms
                      })
                  else:
                      print('      ğŸ˜´ æš‚æ— ç¬¦åˆæ¡ä»¶çš„ç©ºæˆ¿')

                  time.sleep(2)

              except Exception as e:
                  print(f'      âŒ å‡ºé”™: {e}')
              print('-'*40)

          # === å‘é€é‚®ä»¶ ===
          if found_list:
              print(f'\nğŸ“§ å‘é€é‚®ä»¶ ({len(found_list)}ä¸ªç›®æ ‡)...')
              if user_email and resend.api_key:
                  try:
                      first = found_list[0]
                      # æ ‡é¢˜ä¹Ÿè¦ä¼˜åŒ–ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªæŠ“åˆ°çš„å…·ä½“æˆ¿å‹
                      first_detail_name = first['details'][0]['name']
                      subj = f"ã€æœ‰æˆ¿ã€‘{first['name']} {first_detail_name} Â¥{first['price']}"
                      
                      body = "<h3>ğŸ‰ å‘ç°ç©ºæˆ¿æ¸…å•ï¼š</h3>"
                      
                      for item in found_list:
                          body += f"<hr>"
                          body += f"<h4>ğŸ¨ {item['name']} ({item['date']})</h4>"
                          body += f"<p><a href='{item['url']}'>ğŸ‘‰ ç‚¹å‡»ç«‹å³é¢„è®¢</a></p>"
                          
                          # å¼ºåˆ¶æ˜¾ç¤ºè¡¨æ ¼
                          body += "<table border='1' cellpadding='5' style='border-collapse:collapse; width:100%;'>"
                          body += "<tr style='background:#f0f0f0'><th>æˆ¿å‹</th><th>å¸çƒŸ</th><th>ä»·æ ¼</th><th>åº“å­˜/æ¥æº</th></tr>"
                          
                          for d in item['details']:
                              row_style = ""
                              # å¦‚æœæ˜¯æ–‡æœ¬æ¨¡å¼æŠ“åˆ°çš„ï¼Œæ ‡è®°ä¸€ä¸‹
                              source_note = f"å‰©{d['stock']}é—´" if d['source'] == 'json' else "ç½‘é¡µæŠ“å–"
                              
                              body += f"<tr{row_style}><td>{d['name']}</td><td>{d['smoke']}</td><td style='color:red;font-weight:bold;'>Â¥{d['price']}</td><td>{source_note}</td></tr>"
                          body += "</table>"
                      
                      resend.Emails.send({'from': 'onboarding@resend.dev', 'to': user_email, 'subject': subj, 'html': body})
                      print('âœ… é‚®ä»¶å‘é€æˆåŠŸï¼')
                  except Exception as e:
                      print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}')
              else:
                  print('âŒ é‚®ç®±æœªé…ç½®')
          else:
              print('\nğŸ ç›‘æ§ç»“æŸï¼Œæ— ç¬¦åˆæ¡ä»¶æˆ¿æºã€‚')
          EOF
          
          python -u monitor.py
