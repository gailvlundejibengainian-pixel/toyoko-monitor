name: ä¸œæ¨ªInn æˆ¿ä»·ç›‘æ§

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿè¿è¡Œ
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨ç‚¹æŒ‰é’®è¿è¡Œ

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      - name: æ‰¹é‡è¿è¡Œç›‘æ§
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs
          import re

          # 1. åŸºç¡€é…ç½®
          resend.api_key = os.environ.get('RESEND_API_KEY')
          user_email = os.environ.get('USER_EMAIL')
          
          # 2. ä¼ªè£…å¤´ (æ¨¡æ‹Ÿä¸­æ–‡æµè§ˆå™¨)
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept-Language': 'zh-CN,zh;q=0.9', 
          }

          try:
              with open('urls.txt', 'r') as f:
                  urls = [line.strip() for line in f if line.strip()]
          except FileNotFoundError:
              print('âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'ğŸ“‹ å¯åŠ¨ç›‘æ§: {len(urls)} ä¸ªä»»åŠ¡ (é€»è¾‘ï¼šæ‰¾â€œé’±â€å’Œâ€œåº“å­˜â€)\n')
          
          found_list = []

          for i, url in enumerate(urls):
              # è§£æ URL æ˜¾ç¤ºä¿¡æ¯
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  date = params.get('start', ['æœªçŸ¥'])[0]
              except:
                  hotel_id, date = 'æœªçŸ¥', 'æœªçŸ¥'

              print(f'[{i+1}/{len(urls)}] ğŸ¨ {hotel_id} | ğŸ“… {date}')
              
              try:
                  # è¯·æ±‚ç½‘é¡µ
                  resp = requests.get(url, headers=headers, timeout=30)
                  
                  # === æ ¸å¿ƒåˆ¤æ–­é€»è¾‘ (åŸºäºæ‚¨æä¾›çš„ MD æ–‡ä»¶ç‰¹å¾) ===
                  # 1. åªè¦æ˜¯æœ‰æˆ¿ï¼Œä¸€å®šä¼šæ˜¾ç¤ºå…·ä½“ä»·æ ¼ï¼Œæ ¼å¼ä¸º 'Â¥' åè·Ÿæ•°å­— (å¦‚ Â¥8,645)
                  #    æ³¨æ„ï¼šæ— æˆ¿é¡µé¢è™½ç„¶æœ‰ 'ä»·æ ¼' äºŒå­—ï¼Œä½†ä¸ä¼šæœ‰ 'Â¥æ•°å­—' è¿™ç§ç»„åˆ
                  has_money = re.search(r'Â¥\s*[0-9,]{3,}', resp.text)
                  
                  # 2. åªè¦æ˜¯æœ‰æˆ¿ï¼Œé€šå¸¸ä¼šæ˜¾ç¤º 'å‰© X é—´' æˆ–è€… 'é¢„è®¢'
                  #    MDæ–‡ä»¶æ˜¾ç¤ºï¼š'å‰© 8 é—´æˆ¿' æˆ– 'é¢„è®¢'
                  has_stock = re.search(r'å‰©\s*\d+\s*é—´', resp.text)
                  
                  # 3. æ’é™¤å¹²æ‰°ï¼šç¡®ä¿ä¸æ˜¯ 'æ²¡æœ‰ç©ºæˆ¿'
                  #    è™½ç„¶æœ‰æˆ¿é¡µé¢ä¹Ÿå¯èƒ½åŒ…å«å…¶ä»–æˆ¿å‹çš„'æ²¡æœ‰ç©ºæˆ¿'ï¼Œä½†æœ‰æˆ¿é¡µé¢ä¸€å®šä¼šæœ‰æ­£å‘æŒ‡æ ‡
                  
                  # è°ƒè¯•ä¿¡æ¯ï¼šæ‰“å°ç½‘é¡µæ ‡é¢˜ç¡®ä¿æ²¡è·‘å
                  soup = BeautifulSoup(resp.text, 'html.parser')
                  title = soup.title.string.strip() if soup.title else 'æ— æ ‡é¢˜'

                  is_available = False
                  
                  if has_money:
                      print(f'      DEBUG: æ‰¾åˆ°äº†ä»·æ ¼ (å¦‚ {has_money.group()}) -> åˆ¤å®šæœ‰æˆ¿')
                      is_available = True
                  elif has_stock:
                      print(f'      DEBUG: æ‰¾åˆ°äº†åº“å­˜ä¿¡æ¯ ({has_stock.group()}) -> åˆ¤å®šæœ‰æˆ¿')
                      is_available = True
                  
                  if is_available:
                      print(f'      ğŸ‰ å‘ç°ç©ºæˆ¿!')
                      found_list.append({'id': hotel_id, 'date': date, 'url': url, 'title': title})
                  else:
                      print(f'      ğŸ˜´ æš‚æ— ç©ºæˆ¿ (æ ‡é¢˜: {title})')

                  time.sleep(2)

              except Exception as e:
                  print(f'      âŒ å‡ºé”™: {e}')
              print('-'*40)

          # 3. å‘é€é‚®ä»¶
          if found_list:
              print(f'\nğŸ“§ å‘ç° {len(found_list)} ä¸ªç›®æ ‡ï¼Œæ­£åœ¨å‘é€é‚®ä»¶...')
              email_body = '<h3>ğŸ‰å“ªæ€•åªæœ‰ä¸€é—´æˆ¿ï¼Œåªè¦æ˜¾ç¤ºä»·æ ¼å°±é€šçŸ¥ä½ ï¼š</h3><ul>'
              for item in found_list:
                  email_body += f'<li><strong>{item["date"]} (åº—å·{item["id"]})</strong><br><a href="{item["url"]}">ğŸ‘‰ ç‚¹å‡»ç«‹å³é¢„è®¢</a><br><small>{item["title"]}</small></li>'
              email_body += '</ul>'
              
              if resend.api_key:
                  try:
                      resend.Emails.send({
                        'from': 'onboarding@resend.dev',
                        'to': user_email,
                        'subject': f'ã€æœ‰æˆ¿é€ŸæŠ¢ã€‘{found_list[0]["date"]} ä¸œæ¨ªInn',
                        'html': email_body
                      })
                      print('âœ… é‚®ä»¶å‘é€æˆåŠŸ')
                  except Exception as e:
                      print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}')
              else:
                   print('âš ï¸ æœªé…ç½® RESEND_API_KEY')
          else:
              print('\nğŸ ç›‘æ§ç»“æŸï¼Œæš‚æ— å‘ç°ã€‚')
          "
