name: ä¸œæ¨ªInn ä¸¥è°¨ç›‘æ§

on:
  schedule:
    - cron: '*/30 * * * *'  # 30åˆ†é’Ÿä¸€æ¬¡
  workflow_dispatch:

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      - name: æ‰¹é‡è¿è¡Œç›‘æ§
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs
          import re

          # 1. åŸºç¡€é…ç½®
          resend.api_key = os.environ.get('RESEND_API_KEY')
          user_email = os.environ.get('USER_EMAIL')
          
          # 2. ä¼ªè£…å¤´ (æ¨¡æ‹Ÿä¸­æ–‡æµè§ˆå™¨)
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept-Language': 'zh-CN,zh;q=0.9', 
          }

          try:
              with open('urls.txt', 'r') as f:
                  urls = [line.strip() for line in f if line.strip()]
          except FileNotFoundError:
              print('âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'ğŸ“‹ å¯åŠ¨ç›‘æ§: {len(urls)} ä¸ªä»»åŠ¡ (é€»è¾‘ï¼šä¸¥æŸ¥é¢„è®¢å…¥å£)\n')
          
          found_list = []

          for i, url in enumerate(urls):
              # è§£æ URL æ˜¾ç¤ºä¿¡æ¯
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  date_val = params.get('start', ['æœªçŸ¥'])[0]
              except:
                  hotel_id, date_val = 'æœªçŸ¥', 'æœªçŸ¥'

              print(f'[{i+1}/{len(urls)}] ğŸ¨ {hotel_id} | ğŸ“… {date_val}')
              
              try:
                  resp = requests.get(url, headers=headers, timeout=30)
                  soup = BeautifulSoup(resp.text, 'html.parser')
                  
                  # === æ ¸å¿ƒåˆ¤æ–­é€»è¾‘ (ä¸¥è°¨ç‰ˆ) ===
                  text_content = soup.get_text()

                  # åˆ¤æ® A: æ˜ç¡®çš„åº“å­˜æç¤º (å¦‚ 'å‰© 8 é—´')
                  has_stock = re.search(r'å‰©\s*\d+\s*é—´', text_content)
                  
                  # åˆ¤æ® B: çœŸæ­£çš„é¢„è®¢æ“ä½œåŒº
                  # æŸ¥æ‰¾åŒ…å« 'é¢„è®¢' å­—æ ·çš„æŒ‰é’®æˆ–é“¾æ¥ï¼Œä¸”ä¸åœ¨é¡µè„š
                  # é€šå¸¸æ˜¯ä¸€ä¸ª form æˆ– a æ ‡ç­¾
                  has_booking_btn = False
                  # æŸ¥æ‰¾æ‰€æœ‰é“¾æ¥æ–‡æœ¬
                  links = soup.find_all('a')
                  for link in links:
                      if link.get_text() and 'é¢„è®¢' in link.get_text():
                          # æ’é™¤æ‰å¯¼èˆªæ é‡Œçš„ 'æˆ‘çš„é¢„è®¢'
                          if 'æˆ‘çš„' not in link.get_text() and 'ç¡®è®¤' not in link.get_text():
                              has_booking_btn = True
                              break
                  
                  # åˆ¤æ® C: ä»·æ ¼æ£€æµ‹ (æ’é™¤æ‰ 10,000 è¿™ç§æ•´æ•°ï¼Œé€šå¸¸æ˜¯æˆ¿è´¹å¦‚ 8,645)
                  # æŸ¥æ‰¾ Â¥ ç¬¦å·
                  has_real_price = False
                  prices = re.findall(r'Â¥\s*([0-9,]+)', text_content)
                  for p in prices:
                      # å»æ‰é€—å·è½¬æ•°å­—
                      try:
                          val = int(p.replace(',', ''))
                          # çœŸå®çš„ä¸œæ¨ªæˆ¿ä»·é€šå¸¸åœ¨ 3000-20000 ä¹‹é—´ï¼Œä¸”å¾ˆå°‘æ˜¯æ•´æ•´ 10000 (é™¤éæ˜¯ç‰¹æ®Šæˆ¿)
                          # å¦‚æœå…¨æ˜¯ 10000 åˆ™è®¤ä¸ºæ˜¯å¹²æ‰°é¡¹
                          if val != 10000: 
                              has_real_price = True
                      except:
                          pass

                  # ç»¼åˆåˆ¤å®š: å¿…é¡»æ»¡è¶³ (æœ‰åº“å­˜ æˆ– æœ‰çœŸå®ä»·æ ¼ æˆ– æœ‰æŒ‰é’®) ä¸” é¡µé¢ä¸èƒ½å…¨æ˜¯â€œæ²¡æœ‰ç©ºæˆ¿â€
                  # åªè¦æ»¡è¶³ä»»æ„ä¸€ä¸ªå¼ºç‰¹å¾ï¼Œå°±è®¤ä¸ºæœ‰æˆ¿
                  is_available = False
                  
                  if has_stock:
                      print(f'      DEBUG: å‘ç°åº“å­˜ä¿¡æ¯ ({has_stock.group()}) -> æœ‰æˆ¿')
                      is_available = True
                  elif has_booking_btn:
                      print(f'      DEBUG: å‘ç°â€œé¢„è®¢â€æ“ä½œæŒ‰é’® -> æœ‰æˆ¿')
                      is_available = True
                  elif has_real_price and "æ²¡æœ‰ç©ºæˆ¿" not in text_content: 
                      # åªæœ‰åœ¨æ²¡æœ‰æ»¡æˆ¿æ ‡è®°æ—¶ï¼Œæ‰ä¿¡ä»»ä»·æ ¼ï¼Œé˜²æ­¢è¯¯åˆ¤
                      print(f'      DEBUG: å‘ç°æœ‰æ•ˆä»·æ ¼ -> æœ‰æˆ¿')
                      is_available = True
                  
                  if is_available:
                      print(f'      ğŸ‰ å‘ç°ç©ºæˆ¿!')
                      # å­˜å…¥åˆ—è¡¨
                      found_list.append({
                          'id': hotel_id,
                          'date': date_val,
                          'url': url
                      })
                  else:
                      print(f'      ğŸ˜´ æš‚æ— ç©ºæˆ¿')

                  time.sleep(2)

              except Exception as e:
                  print(f'      âŒ å‡ºé”™: {e}')
              print('-'*40)

          # 3. å‘é€é‚®ä»¶ (ä¿®å¤äº† KeyError é—®é¢˜)
          if found_list:
              print(f'\nğŸ“§ å‘ç° {len(found_list)} ä¸ªç›®æ ‡ï¼Œæ­£åœ¨å‘é€é‚®ä»¶...')
              
              # ç®€å•çš„ HTML æ‹¼æ¥
              email_body = '<h3>ğŸ‰ ä»¥ä¸‹è¡Œç¨‹å‘ç°ç©ºæˆ¿ï¼š</h3><ul>'
              
              # æ³¨æ„ï¼šè¿™é‡Œä¸¥æ ¼ä½¿ç”¨äº†åŒå¼•å·å’Œæ­£ç¡®çš„ key å
              for item in found_list:
                  u = item['url']
                  d = item['date']
                  h = item['id']
                  email_body += f'<li><strong>{d} (åº—å·{h})</strong><br><a href="{u}">ğŸ‘‰ ç‚¹å‡»ç«‹å³é¢„è®¢</a></li>'
              
              email_body += '</ul>'
              
              if resend.api_key:
                  try:
                      resend.Emails.send({
                        'from': 'onboarding@resend.dev',
                        'to': user_email,
                        'subject': f'ã€æœ‰æˆ¿é€ŸæŠ¢ã€‘{found_list[0]["date"]} ä¸œæ¨ªInn',
                        'html': email_body
                      })
                      print('âœ… é‚®ä»¶å‘é€æˆåŠŸ')
                  except Exception as e:
                      print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}')
              else:
                   print('âš ï¸ æœªé…ç½® RESEND_API_KEY')
          else:
              print('\nğŸ ç›‘æ§ç»“æŸï¼Œæš‚æ— å‘ç°ã€‚')
          "
