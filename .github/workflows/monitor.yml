name: ä¸œæ¨ªInn ç›‘æ§ (v13.0 æ—¶é—´ç®¡ç†å¤§å¸ˆç‰ˆ)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      - name: æ‰¹é‡è¿è¡Œç›‘æ§
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs, unquote
          import json
          import traceback
          from datetime import datetime, timedelta, timezone

          # === 0. æ—¶é—´æ§åˆ¶å™¨é€»è¾‘ ===
          def check_is_run_time():
              # é»˜è®¤è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
              tz_beijing = timezone(timedelta(hours=8))
              now = datetime.now(tz_beijing)
              current_hour = now.hour
              
              print(f'ğŸ•’ å½“å‰åŒ—äº¬æ—¶é—´: {now.strftime(\"%Y-%m-%d %H:%M:%S\")}')

              try:
                  with open('run_time.txt', 'r') as f:
                      content = f.read().strip()
                      # æ ¼å¼é¢„æœŸ: 08-23 (ä»£è¡¨ 08:00 åˆ° 23:59 è¿è¡Œ)
                      if '-' in content:
                          start_str, end_str = content.split('-')
                          start_h = int(start_str)
                          end_h = int(end_str)
                          
                          # é€»è¾‘: åŒ…å«èµ·å§‹ï¼ŒåŒ…å«ç»“æŸ
                          # æ¯”å¦‚ 08-22: 8ç‚¹è·‘...22ç‚¹è·‘ï¼Œ23ç‚¹åœ
                          is_running = False
                          
                          if start_h <= end_h:
                              # ç™½å¤©æ¨¡å¼ (ä¾‹å¦‚ 08-23)
                              if start_h <= current_hour <= end_h:
                                  is_running = True
                          else:
                              # è·¨å¤œæ¨¡å¼ (ä¾‹å¦‚ 22-06ï¼Œæ™šä¸Š10ç‚¹åˆ°æ¬¡æ—¥6ç‚¹)
                              if current_hour >= start_h or current_hour <= end_h:
                                  is_running = True
                                  
                          if not is_running:
                              print(f'ğŸ’¤ ä¹Ÿå°±æ˜¯éè¿è¡Œæ—¶é—´ (è®¾å®š: {start_h}:00 - {end_h}:59)')
                              print('ğŸ’¤ è„šæœ¬è¿›å…¥ä¼‘çœ æ¨¡å¼ï¼Œä¸æ‰§è¡ŒæŸ¥è¯¢ã€‚')
                              return False
                          else:
                              print(f'âœ… å¤„äºè¿è¡Œæ—¶é—´æ®µ ({start_h}-{end_h})ï¼Œç»§ç»­æ‰§è¡Œ...')
                              return True
              except FileNotFoundError:
                  print('âš ï¸ æœªæ‰¾åˆ° run_time.txtï¼Œé»˜è®¤å…¨å¤©å€™è¿è¡Œ (24h)ã€‚')
                  return True
              except Exception as e:
                  print(f'âš ï¸ æ—¶é—´é…ç½®è§£æé”™è¯¯: {e}ï¼Œé»˜è®¤ç»§ç»­è¿è¡Œã€‚')
                  return True
              
              return True

          # å¦‚æœä¸åœ¨è¿è¡Œæ—¶é—´ï¼Œç›´æ¥é€€å‡º
          if not check_is_run_time():
              exit(0)

          # === ä»¥ä¸‹æ˜¯ v12.0 çš„æ ¸å¿ƒé€»è¾‘ ===
          
          # === é…ç½®åŒº ===
          resend.api_key = os.environ.get('RESEND_API_KEY')
          user_email = os.environ.get('USER_EMAIL', '').strip()
          
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          }

          try:
              with open('urls.txt', 'r') as f:
                  urls = [line.strip() for line in f if line.strip()]
          except FileNotFoundError:
              print('âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'\nğŸ“‹ å¯åŠ¨ç›‘æ§: {len(urls)} ä¸ªä»»åŠ¡ (v13.0 æ—¶é—´ç®¡ç†ç‰ˆ)\n')
          
          found_list = []

          for i, url in enumerate(urls):
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  checkin_date = params.get('start', ['æœªçŸ¥'])[0]
                  
                  max_price = 999999
                  if 'max' in params:
                      try: max_price = int(params['max'][0])
                      except: pass
                  
                  target_room = None
                  if 'roomtype' in params:
                      target_room = unquote(params['roomtype'][0])

                  target_smoke = None 
                  if 'smoke' in params:
                      val = params['smoke'][0]
                      if val == '1': target_smoke = True
                      elif val == '0': target_smoke = False

              except:
                  hotel_id, checkin_date = 'æœªçŸ¥', 'æœªçŸ¥'
                  max_price = 999999
                  target_room = None
                  target_smoke = None

              req_info = []
              if target_room: req_info.append(f'æˆ¿å‹[{target_room}]')
              if target_smoke is True: req_info.append('[ğŸš¬å¸çƒŸ]')
              elif target_smoke is False: req_info.append('[ğŸš­ç¦çƒŸ]')
              if max_price < 999999: req_info.append(f'é¢„ç®—<{max_price}')
              
              req_str = ', '.join(req_info) if req_info else 'æ— ç­›é€‰'
              print(f'[{i+1}/{len(urls)}] ğŸ¨ {hotel_id} | ğŸ“… {checkin_date} | {req_str}')

              try:
                  resp = requests.get(url, headers=headers, timeout=30)
                  
                  if '__NEXT_DATA__' not in resp.text and ('ç³»ç»Ÿç»´æŠ¤' in resp.text or 'maintenance' in resp.text.lower()):
                      print(f'      ğŸš§ å®˜ç½‘ç³»ç»Ÿç»´æŠ¤ä¸­')
                      print('-'*40)
                      continue

                  soup = BeautifulSoup(resp.text, 'html.parser')
                  script = soup.find('script', id='__NEXT_DATA__')
                  
                  if not script:
                      print('      âš ï¸ æ— æ³•è·å– JSON æ•°æ®')
                      print('-'*40)
                      continue
                      
                  data = json.loads(script.string)
                  
                  try:
                      hotel_name = data['props']['pageProps']['hotel']['hotelName']
                  except:
                      hotel_name = f'é…’åº—{hotel_id}'

                  try:
                      room_plan_list = data['props']['pageProps']['roomPlanList']
                  except KeyError:
                      print('      âš ï¸ JSON ç»“æ„å¼‚å¸¸')
                      continue

                  valid_rooms = []
                  
                  for plan in room_plan_list:
                      room_types = plan.get('roomTypes', [])
                      for room in room_types:
                          r_name = room.get('roomTypeName', '')
                          specs = room.get('specs', {})
                          is_smoking = specs.get('isSmoking', False)
                          
                          vacant = room.get('vacant', {})
                          stock = vacant.get('generalVacantRoom', 0)
                          if stock is None: stock = 0
                          
                          price_obj = room.get('price', {})
                          price = price_obj.get('generalPrice', 999999)
                          
                          if stock <= 0: continue 
                          if target_room and target_room not in r_name: continue
                          if target_smoke is not None and target_smoke != is_smoking: continue
                          if price > max_price: continue

                          smoke_str = 'å¸çƒŸ' if is_smoking else 'ç¦çƒŸ'
                          
                          valid_rooms.append({
                              'name': r_name,
                              'smoke': smoke_str,
                              'price': price,
                              'stock': stock,
                              'plan': plan.get('planName', 'æ ‡å‡†å¥—é¤')
                          })

                  if valid_rooms:
                      best = min(valid_rooms, key=lambda x: x['price'])
                      print(f'      ğŸ‰ å‘ç°! {best['name']}({best['smoke']}) Â¥{best['price']}')
                      
                      found_list.append({
                          'id': hotel_id,
                          'name': hotel_name,
                          'date': checkin_date,
                          'url': url,
                          'room': best['name'],
                          'smoke': best['smoke'],
                          'price': best['price'],
                          'details': valid_rooms
                      })
                  else:
                      print(f'      ğŸ˜´ æ— ç¬¦åˆæˆ¿æº')
                  
                  time.sleep(2)

              except Exception as e:
                  print(f'      âŒ å‡ºé”™: {e}')
                  traceback.print_exc()
              print('-'*40)

          if found_list:
              print(f'\nğŸ“§ å‘ç° {len(found_list)} ä¸ªç›®æ ‡ï¼Œå‘é€é‚®ä»¶...')
              if not user_email or not resend.api_key:
                  print('âŒ é‚®ç®±é…ç½®ç¼ºå¤±')
              else:
                  try:
                      first = found_list[0]
                      subject_txt = f'ã€æœ‰æˆ¿ã€‘{first["name"]} {first["date"]} {first["room"]}'
                      
                      html = '<h3>ğŸ‰ å‘ç°ç¬¦åˆç­›é€‰æ¡ä»¶çš„ç©ºæˆ¿ï¼š</h3>'
                      for item in found_list:
                          html += f'<hr><h4>ğŸ¨ {item["name"]} ({item["date"]})</h4>'
                          html += f'<p><strong>æœ€ä½ä»·:</strong> <span style="color:red">Â¥{item["price"]}</span></p>'
                          html += f'<p><a href="{item["url"]}">ğŸ‘‰ ç‚¹å‡»ç«‹å³é¢„è®¢</a></p>'
                          html += '<ul>'
                          deduplicated = {}
                          for d in item["details"]:
                              key = f'{d["name"]}-{d["smoke"]}-{d["price"]}'
                              if key not in deduplicated:
                                  deduplicated[key] = d
                                  html += f'<li>{d["name"]} ({d["smoke"]}): <strong>Â¥{d["price"]}</strong> (å‰©{d["stock"]}é—´)</li>'
                          html += '</ul>'
                  
                      resend.Emails.send({'from': 'onboarding@resend.dev', 'to': user_email, 'subject': subject_txt, 'html': html})
                      print('âœ… é‚®ä»¶å‘é€æˆåŠŸï¼')
                  except Exception as e:
                      print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}')
          else:
              print('\nğŸ ç›‘æ§ç»“æŸã€‚')
          "
