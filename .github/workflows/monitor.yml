name: ä¸œæ¨ªInn ç›‘æ§ (v24.0 è¡¨æ ¼ä¿®å¤ç‰ˆ)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      - name: ç”Ÿæˆå¹¶è¿è¡Œè„šæœ¬
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          cat << 'EOF' > monitor.py
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs, unquote
          import json
          import re
          from datetime import datetime, timedelta, timezone

          # === 1. æ—¶é—´æ§åˆ¶å™¨ ===
          try:
              tz_beijing = timezone(timedelta(hours=8))
              now = datetime.now(tz_beijing)
              if os.path.exists('run_time.txt'):
                  with open('run_time.txt', 'r') as f:
                      content = f.read().strip()
                      if '-' in content:
                          s, e = map(int, content.split('-'))
                          h = now.hour
                          is_run = (s <= h <= e) if s <= e else (h >= s or h <= e)
                          if not is_run:
                              print(f'ğŸ’¤ ä¼‘çœ æ—¶é—´ ({s}-{e})ï¼Œå½“å‰ {h} ç‚¹ã€‚')
                              exit(0)
          except: pass

          # === 2. åŸºç¡€é…ç½® ===
          resend.api_key = os.environ.get('RESEND_API_KEY')
          user_email = os.environ.get('USER_EMAIL', '').strip()
          
          # å¼ºåŠ›æµè§ˆå™¨ä¼ªè£…
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
              'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
              'Referer': 'https://www.toyoko-inn.com/china_cn/',
              'Connection': 'keep-alive',
          }

          urls = []
          try:
              with open('urls.txt', 'r') as f:
                  for line in f:
                      line = line.strip()
                      if line and not line.startswith('#'):
                          urls.append(line)
          except:
              print('âŒ æ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'\nğŸ“‹ å¯åŠ¨ç›‘æ§: {len(urls)} ä¸ªä»»åŠ¡ (v24.0 è¡¨æ ¼ä¿®å¤ç‰ˆ)\n')
          
          session = requests.Session()
          session.headers.update(headers)
          
          # é¢„çƒ­
          try: session.get('https://www.toyoko-inn.com/china_cn/', timeout=5)
          except: pass

          found_list = []

          for i, url in enumerate(urls):
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  checkin_date = params.get('start', ['æœªçŸ¥'])[0]
                  
                  max_price = 999999
                  if 'max' in params:
                      try: max_price = int(params['max'][0])
                      except: pass
                  
                  target_room = None
                  if 'roomtype' in params: target_room = unquote(params['roomtype'][0])
                  
                  target_smoke = None 
                  if 'smoke' in params:
                      val = params['smoke'][0]
                      if val == '1': target_smoke = True
                      elif val == '0': target_smoke = False
              except:
                  hotel_id, checkin_date = 'æœªçŸ¥', 'æœªçŸ¥'
                  max_price = 999999
                  target_room, target_smoke = None, None

              print(f'[{i+1}/{len(urls)}] ğŸ¨ {hotel_id} | ğŸ“… {checkin_date}')

              detailed_rooms = [] 
              text_prices = []
              final_hotel_name = f"é…’åº—{hotel_id}" # é»˜è®¤åå­—

              try:
                  resp = session.get(url, timeout=30)
                  soup = BeautifulSoup(resp.text, 'html.parser')
                  
                  # === ğŸ”¥ ä¼˜å…ˆæŠ“å–é…’åº—åå­— (æ— è®ºJSONæ˜¯å¦æˆåŠŸ) ===
                  try:
                      h1 = soup.find('h1')
                      if h1:
                          raw_name = h1.get_text(strip=True)
                          # å»é™¤å¯èƒ½çš„å¹²æ‰°è¯
                          final_hotel_name = raw_name.replace('é€‰æ‹©å¥—é¤', '').replace('ä¸œæ¨ªINN', '').strip()
                          final_hotel_name = f"ä¸œæ¨ªINN {final_hotel_name}"
                  except: pass

                  # === å¼•æ“ A: JSON è§£æ (ç”Ÿæˆè¡¨æ ¼) ===
                  json_success = False
                  if '__NEXT_DATA__' in resp.text:
                      try:
                          script = soup.find('script', id='__NEXT_DATA__')
                          data = json.loads(script.string)
                          room_plan_list = data.get('props', {}).get('pageProps', {}).get('roomPlanList', [])
                          if room_plan_list is None: room_plan_list = []
                          
                          # å¦‚æœJSONé‡Œæœ‰åå­—ï¼Œç”¨JSONçš„ï¼ˆæ›´å‡†ï¼‰
                          try:
                              hn = data.get('props', {}).get('pageProps', {}).get('hotel', {}).get('hotelName', '')
                              if hn: final_hotel_name = hn
                          except: pass

                          for plan in room_plan_list:
                              room_types = plan.get('roomTypes', [])
                              for room in room_types:
                                  r_name = room.get('roomTypeName', '')
                                  specs = room.get('specs', {})
                                  is_smoking = specs.get('isSmoking', False)
                                  
                                  vacant = room.get('vacant', {})
                                  stock = vacant.get('generalVacantRoom', 0)
                                  if stock is None: stock = 0
                                  
                                  price_obj = room.get('price', {})
                                  price = price_obj.get('generalPrice', 999999)
                                  
                                  # ç­›é€‰é€»è¾‘
                                  if stock <= 0: continue
                                  if price > max_price: continue
                                  if target_room and target_room not in r_name: continue
                                  if target_smoke is not None and target_smoke != is_smoking: continue
                                  
                                  smoke_str = 'å¸çƒŸ' if is_smoking else 'ç¦çƒŸ'
                                  detailed_rooms.append({
                                      'name': r_name,
                                      'smoke': smoke_str,
                                      'price': price,
                                      'stock': stock
                                  })
                          json_success = True
                      except Exception as e:
                          print(f'      âš ï¸ JSON è§£æå¾®å°é”™è¯¯: {e}')

                  # === å¼•æ“ B: æ–‡æœ¬æ‰«æ (å…œåº•) ===
                  # åªæœ‰å½“è¯¦ç»†åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œæ‰å¯ç”¨æ–‡æœ¬æ‰«æï¼ŒæŠŠæ‰€æœ‰çœ‹åˆ°çš„ä»·æ ¼éƒ½æŠ“ä¸‹æ¥
                  if not detailed_rooms:
                      # ç²—æš´å»å™ª
                      for t in soup(['script', 'style', 'header', 'footer']): t.decompose()
                      clean_text = soup.get_text()
                      
                      # æ‰¾æ‰€æœ‰ä»·æ ¼
                      raw_prices = re.findall(r'Â¥\s*([0-9,]+)', clean_text)
                      for p in raw_prices:
                          try:
                              v = int(p.replace(',', ''))
                              # æ’é™¤å¹²æ‰°é¡¹
                              if v > 4000 and v != 10000 and v <= max_price: 
                                  text_prices.append(v)
                          except: pass
                      text_prices = sorted(list(set(text_prices))) # å»é‡æ’åº

                  # === å†³ç­–æ—¶åˆ» ===
                  final_item = None
                  
                  if detailed_rooms:
                      best = min(detailed_rooms, key=lambda x: x['price'])
                      print(f'      ğŸ‰ åˆ—è¡¨æ¨¡å¼: å‘ç° {len(detailed_rooms)} ä¸ªæˆ¿å‹! æœ€ä½: {best["name"]} Â¥{best["price"]}')
                      final_item = {
                          'name': final_hotel_name,
                          'date': checkin_date,
                          'url': url,
                          'price': best['price'],
                          'details': detailed_rooms,
                          'type': 'json'
                      }
                      
                  elif text_prices:
                      min_p = min(text_prices)
                      print(f'      ğŸ‰ æ–‡æœ¬æ¨¡å¼: å‘ç°ä»·æ ¼ {text_prices}')
                      final_item = {
                          'name': final_hotel_name,
                          'date': checkin_date,
                          'url': url,
                          'price': min_p,
                          'details': [],
                          'text_prices': text_prices, # ä¼ ç»™é‚®ä»¶
                          'type': 'text'
                      }
                  else:
                      print('      ğŸ˜´ æš‚æ— ç¬¦åˆæ¡ä»¶çš„ç©ºæˆ¿')

                  if final_item:
                      found_list.append(final_item)
                  
                  time.sleep(2)

              except Exception as e:
                  print(f'      âŒ å‡ºé”™: {e}')

              print('-'*40)

          # === å‘é€é‚®ä»¶ ===
          if found_list:
              print(f'\nğŸ“§ å‘é€é‚®ä»¶ ({len(found_list)}ä¸ªç›®æ ‡)...')
              if user_email and resend.api_key:
                  try:
                      first = found_list[0]
                      subj = f"ã€æœ‰æˆ¿ã€‘{first['name']} {first['date']} Â¥{first['price']}"
                      
                      body = "<h3>ğŸ‰ å‘ç°ç©ºæˆ¿æ¸…å•ï¼š</h3>"
                      
                      for item in found_list:
                          body += f"<hr>"
                          body += f"<h4>ğŸ¨ {item['name']} ({item['date']})</h4>"
                          body += f"<p><a href='{item['url']}'>ğŸ‘‰ ç‚¹å‡»ç«‹å³é¢„è®¢</a></p>"
                          
                          if item['type'] == 'json' and item['details']:
                              # è¡¨æ ¼æ¨¡å¼
                              body += "<table border='1' cellpadding='5' style='border-collapse:collapse; width:100%;'>"
                              body += "<tr style='background:#f0f0f0'><th>æˆ¿å‹</th><th>å¸çƒŸ</th><th>ä»·æ ¼</th><th>åº“å­˜</th></tr>"
                              
                              seen = set()
                              for d in item['details']:
                                  key = f"{d['name']}-{d['smoke']}-{d['price']}"
                                  if key not in seen:
                                      seen.add(key)
                                      body += f"<tr><td>{d['name']}</td><td>{d['smoke']}</td><td style='color:red;font-weight:bold;'>Â¥{d['price']}</td><td>å‰©{d['stock']}é—´</td></tr>"
                              body += "</table>"
                          
                          elif item['type'] == 'text' and 'text_prices' in item:
                              # æ–‡æœ¬åˆ—è¡¨æ¨¡å¼
                              body += "<p><strong>âš ï¸ æœªèƒ½è¯»å–è¯¦ç»†æˆ¿å‹ (å¯èƒ½éœ€ç™»å½•)ï¼Œä½†æ£€æµ‹åˆ°ä»¥ä¸‹ä»·æ ¼ï¼š</strong></p>"
                              body += "<ul>"
                              for p in item['text_prices']:
                                   body += f"<li><span style='color:red;font-weight:bold;'>Â¥{p}</span></li>"
                              body += "</ul>"
                      
                      resend.Emails.send({'from': 'onboarding@resend.dev', 'to': user_email, 'subject': subj, 'html': body})
                      print('âœ… é‚®ä»¶å‘é€æˆåŠŸï¼')
                  except Exception as e:
                      print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}')
              else:
                  print('âŒ é‚®ç®±æœªé…ç½®')
          else:
              print('\nğŸ ç›‘æ§ç»“æŸï¼Œæ— ç¬¦åˆæ¡ä»¶æˆ¿æºã€‚')
          EOF
          
          python -u monitor.py
