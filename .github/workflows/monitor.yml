name: ä¸œæ¨ªInn ç›‘æ§ (15åˆ†é’Ÿç‰ˆ)

on:
  schedule:
    - cron: '7,22,37,52 * * * *'
  workflow_dispatch:        # æ‰‹åŠ¨
  push:                     # å¢åŠ è¿™ä¸€è¡Œï¼šåªè¦æœ‰ä»£ç æäº¤å°±è¿è¡Œ
    branches:
      - main

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      - name: æ‰¹é‡è¿è¡Œç›‘æ§
        env:
          # åŠ¡å¿…ç¡®ä¿åœ¨ GitHub Settings -> Secrets é‡Œé…ç½®äº†è¿™ä¸¤ä¸ªå˜é‡
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs
          import re

          # 1. åŸºç¡€é…ç½® (å¢åŠ å®¹é”™å¤„ç†)
          resend.api_key = os.environ.get('RESEND_API_KEY')
          
          # è·å–é‚®ç®±å¹¶è‡ªåŠ¨å»é™¤é¦–å°¾ç©ºæ ¼ï¼Œé˜²æ­¢å¤åˆ¶ç²˜è´´æ—¶å¸¦å…¥ç©ºæ ¼å¯¼è‡´æŠ¥é”™
          raw_email = os.environ.get('USER_EMAIL', '')
          user_email = raw_email.strip()

          # 2. ä¼ªè£…å¤´
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept-Language': 'zh-CN,zh;q=0.9', 
          }

          try:
              with open('urls.txt', 'r') as f:
                  urls = [line.strip() for line in f if line.strip()]
          except FileNotFoundError:
              print('âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'ğŸ“‹ å¯åŠ¨ç›‘æ§: {len(urls)} ä¸ªä»»åŠ¡ (15åˆ†é’Ÿ/æ¬¡)\n')
          
          found_list = []

          for i, url in enumerate(urls):
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  checkin_date = params.get('start', ['æœªçŸ¥'])[0]
              except:
                  hotel_id, checkin_date = 'æœªçŸ¥', 'æœªçŸ¥'

              print(f'[{i+1}/{len(urls)}] ğŸ¨ {hotel_id} | ğŸ“… {checkin_date}')
              
              try:
                  resp = requests.get(url, headers=headers, timeout=30)
                  text_content = resp.text
                  
                  # === æ ¸å¿ƒåˆ¤å®šé€»è¾‘ ===
                  # 1. åº“å­˜æ£€æµ‹ (å‰© x é—´)
                  has_stock = re.search(r'å‰©\s*\d+\s*é—´', text_content)
                  
                  # 2. é¢„è®¢æŒ‰é’®æ£€æµ‹
                  has_booking_btn = False
                  if 'reserve/input' in text_content or 'value=\"é¢„è®¢\"' in text_content:
                      has_booking_btn = True
                  
                  # 3. çœŸå®ä»·æ ¼æ£€æµ‹ (è¿‡æ»¤æ‰10000)
                  has_real_price = False
                  prices = re.findall(r'Â¥\s*([0-9,]+)', text_content)
                  for p in prices:
                      try:
                          val = int(p.replace(',', ''))
                          if val != 10000: has_real_price = True
                      except: pass

                  # ç»¼åˆåˆ¤å®š
                  is_available = False
                  if has_stock:
                      print(f'      DEBUG: å‘ç°åº“å­˜ ({has_stock.group()}) -> æœ‰æˆ¿')
                      is_available = True
                  elif has_booking_btn:
                      print(f'      DEBUG: å‘ç°é¢„è®¢æŒ‰é’® -> æœ‰æˆ¿')
                      is_available = True
                  elif has_real_price and 'æ²¡æœ‰ç©ºæˆ¿' not in text_content:
                      print(f'      DEBUG: å‘ç°ä»·æ ¼ -> æœ‰æˆ¿')
                      is_available = True
                  
                  if is_available:
                      print(f'      ğŸ‰ å‘ç°ç©ºæˆ¿!')
                      found_list.append({
                          'id': hotel_id,
                          'date': checkin_date,
                          'url': url
                      })
                  else:
                      print(f'      ğŸ˜´ æš‚æ— ç©ºæˆ¿')

                  time.sleep(2)

              except Exception as e:
                  print(f'      âŒ å‡ºé”™: {e}')
              print('-'*40)

          # 3. å‘é€é‚®ä»¶ (å¢å¼ºç‰ˆ)
          if found_list:
              print(f'\nğŸ“§ å‘ç° {len(found_list)} ä¸ªç›®æ ‡ï¼Œæ­£åœ¨å‡†å¤‡å‘é€é‚®ä»¶...')
              
              # æ£€æŸ¥é‚®ç®±é…ç½®
              if not user_email or '@' not in user_email:
                  print('âŒ é”™è¯¯ï¼šUSER_EMAIL æœªé…ç½®æˆ–æ ¼å¼é”™è¯¯ï¼')
                  print('   è¯·åœ¨ GitHub -> Settings -> Secrets and variables -> Actions ä¸­æ·»åŠ  USER_EMAIL')
                  # ä¸é€€å‡ºï¼Œåªæ‰“å°é”™è¯¯ï¼Œé˜²æ­¢å‰é¢çš„ç›‘æ§ç™½è·‘
              elif not resend.api_key:
                  print('âŒ é”™è¯¯ï¼šRESEND_API_KEY æœªé…ç½®ï¼')
              else:
                  # æ„å»ºé‚®ä»¶
                  first_date = found_list[0]['date']
                  subject_txt = f'ã€æœ‰æˆ¿æé†’ã€‘{first_date} ä¸œæ¨ªInn ({len(found_list)}ä¸ªç»“æœ)'
                  
                  email_body = '<h3>ğŸ‰ å‘ç°ä»¥ä¸‹ç©ºæˆ¿ï¼š</h3><ul>'
                  for item in found_list:
                      d = item['date']
                      h = item['id']
                      u = item['url']
                      email_body += f'<li><strong>{d} (åº—å·{h})</strong><br><a href=\"{u}\">ğŸ‘‰ ç‚¹å‡»ç«‹å³é¢„è®¢</a></li>'
                  email_body += '</ul>'
                  
                  try:
                      print(f'   æ­£åœ¨å‘é€ç»™: {user_email} ...')
                      resend.Emails.send({
                        'from': 'onboarding@resend.dev',
                        'to': user_email,
                        'subject': subject_txt,
                        'html': email_body
                      })
                      print('âœ… é‚®ä»¶å‘é€æˆåŠŸï¼')
                  except Exception as e:
                      print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}')
          else:
              print('\nğŸ ç›‘æ§ç»“æŸï¼Œæš‚æ— å‘ç°ã€‚')
          "
# æ¿€æ´»å®šæ—¶ä»»åŠ¡ 2026-01-25
