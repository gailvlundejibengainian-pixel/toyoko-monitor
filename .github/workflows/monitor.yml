name: ä¸œæ¨ªInn ç›‘æ§ (v16.0 å¼ºåŠ›ç©¿é€ç‰ˆ)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      - name: æ‰¹é‡è¿è¡Œç›‘æ§
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs, unquote
          import json
          import traceback
          from datetime import datetime, timedelta, timezone

          # === 0. æ—¶é—´æ§åˆ¶å™¨ ===
          def check_is_run_time():
              tz_beijing = timezone(timedelta(hours=8))
              now = datetime.now(tz_beijing)
              current_hour = now.hour
              print(f'ğŸ•’ å½“å‰åŒ—äº¬æ—¶é—´: {now.strftime(\"%Y-%m-%d %H:%M:%S\")}')
              try:
                  with open('run_time.txt', 'r') as f:
                      content = f.read().strip()
                      if '-' in content:
                          start_str, end_str = content.split('-')
                          start_h, end_h = int(start_str), int(end_str)
                          is_running = False
                          if start_h <= end_h:
                              if start_h <= current_hour <= end_h: is_running = True
                          else:
                              if current_hour >= start_h or current_hour <= end_h: is_running = True
                          
                          if not is_running:
                              print(f'ğŸ’¤ ä¼‘çœ æ—¶é—´ ({start_h}-{end_h})ï¼Œè·³è¿‡æŸ¥è¯¢ã€‚')
                              return False
                          print(f'âœ… è¿è¡Œæ—¶é—´ ({start_h}-{end_h})ï¼Œç»§ç»­...')
              except: pass
              return True

          if not check_is_run_time(): exit(0)

          # === é…ç½®åŒº ===
          resend.api_key = os.environ.get('RESEND_API_KEY')
          user_email = os.environ.get('USER_EMAIL', '').strip()
          
          # ğŸ”¥ å‡çº§è¯·æ±‚å¤´ï¼šä¼ªè£…æˆçœŸå®æµè§ˆå™¨
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
              'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
              'Accept-Encoding': 'gzip, deflate, br',
              'Connection': 'keep-alive',
              'Upgrade-Insecure-Requests': '1',
              'Referer': 'https://www.toyoko-inn.com/china_cn/',
              'Cache-Control': 'max-age=0',
          }

          clean_urls = []
          try:
              with open('urls.txt', 'r') as f:
                  for line in f:
                      line = line.strip()
                      if not line or line.startswith('#'): continue
                      clean_urls.append(line)
          except FileNotFoundError:
              print('âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'\nğŸ“‹ å¯åŠ¨ç›‘æ§: {len(clean_urls)} ä¸ªä»»åŠ¡ (v16.0 å¼ºåŠ›ç©¿é€ç‰ˆ)\n')
          
          # å»ºç«‹é•¿è¿æ¥ Session
          session = requests.Session()
          session.headers.update(headers)
          
          found_list = []

          for i, url in enumerate(clean_urls):
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  checkin_date = params.get('start', ['æœªçŸ¥'])[0]
                  
                  max_price = 999999
                  if 'max' in params:
                      try: max_price = int(params['max'][0])
                      except: pass
                  
                  target_room = None
                  if 'roomtype' in params: target_room = unquote(params['roomtype'][0])
                  
                  target_smoke = None 
                  if 'smoke' in params:
                      val = params['smoke'][0]
                      if val == '1': target_smoke = True
                      elif val == '0': target_smoke = False

              except:
                  hotel_id, checkin_date = 'æœªçŸ¥', 'æœªçŸ¥'
                  max_price = 999999
                  target_room, target_smoke = None, None

              filter_info = []
              if max_price < 999999: filter_info.append(f'<{max_price}')
              if target_room: filter_info.append(f'[{target_room}]')
              if target_smoke is True: filter_info.append('[å¸çƒŸ]')
              elif target_smoke is False: filter_info.append('[ç¦çƒŸ]')
              
              req_str = ', '.join(filter_info) if filter_info else 'æ— ç­›é€‰'
              print(f'[{i+1}/{len(clean_urls)}] ğŸ¨ {hotel_id} | ğŸ“… {checkin_date} | {req_str}')

              # === ğŸ”¥ é‡è¯•å¾ªç¯ ===
              max_retries = 3
              success = False
              
              for attempt in range(max_retries):
                  try:
                      resp = session.get(url, timeout=30)
                      
                      # ç»´æŠ¤æ£€æµ‹
                      if '__NEXT_DATA__' not in resp.text and ('ç³»ç»Ÿç»´æŠ¤' in resp.text or 'maintenance' in resp.text.lower()):
                          print(f'      ğŸš§ å®˜ç½‘ç³»ç»Ÿç»´æŠ¤ä¸­ (å°è¯• {attempt+1}/{max_retries})')
                          time.sleep(5)
                          continue

                      soup = BeautifulSoup(resp.text, 'html.parser')
                      script = soup.find('script', id='__NEXT_DATA__')
                      
                      if not script:
                          print(f'      âš ï¸ æ— æ³•è·å– JSON (å°è¯• {attempt+1}/{max_retries})')
                          time.sleep(5)
                          continue
                          
                      data = json.loads(script.string)
                      page_props = data.get('props', {}).get('pageProps', {})
                      room_plan_list = page_props.get('roomPlanList', [])
                      
                      # å¦‚æœæ•°æ®ä¸ºç©ºï¼Œå¯èƒ½æ˜¯è¢«è½¯æ‹¦æˆªï¼Œå¼ºåˆ¶é‡è¯•
                      if room_plan_list is None or len(room_plan_list) == 0:
                          # å¢åŠ è¯¦ç»† Debug ä¿¡æ¯ï¼Œçœ‹çœ‹åˆ°åº•è¿”å›äº†å•¥
                          err_debug = f"Keys: {list(page_props.keys())}"
                          print(f'      âš ï¸ è·å–åˆ°ç©ºåˆ—è¡¨ (å°è¯• {attempt+1}/{max_retries}) - {err_debug}')
                          time.sleep(5)
                          continue
                      
                      # æˆåŠŸè·å–æ•°æ®
                      success = True
                      
                      # è·å–é…’åº—å
                      hotel_name = f'é…’åº—{hotel_id}'
                      try: hotel_name = page_props['hotel']['hotelName']
                      except: pass
                      
                      valid_rooms = []
                      
                      for plan in room_plan_list:
                          room_types = plan.get('roomTypes', [])
                          for room in room_types:
                              r_name = room.get('roomTypeName', '')
                              specs = room.get('specs', {})
                              is_smoking = specs.get('isSmoking', False)
                              
                              vacant = room.get('vacant', {})
                              stock = vacant.get('generalVacantRoom', 0)
                              if stock is None: stock = 0
                              
                              price_obj = room.get('price', {})
                              price = price_obj.get('generalPrice', 999999)
                              
                              # ç­›é€‰é€»è¾‘
                              if stock <= 0: continue 
                              if price > max_price: continue
                              if target_room and target_room not in r_name: continue
                              if target_smoke is not None and target_smoke != is_smoking: continue

                              smoke_str = 'å¸çƒŸ' if is_smoking else 'ç¦çƒŸ'
                              valid_rooms.append({
                                  'name': r_name,
                                  'smoke': smoke_str,
                                  'price': price,
                                  'stock': stock,
                                  'plan': plan.get('planName', 'æ ‡å‡†å¥—é¤')
                              })

                      if valid_rooms:
                          best = min(valid_rooms, key=lambda x: x['price'])
                          b_name = best['name']
                          b_smoke = best['smoke']
                          b_price = best['price']
                          print(f'      ğŸ‰ å‘ç°! {b_name}({b_smoke}) Â¥{b_price}')
                          
                          found_list.append({
                              'id': hotel_id,
                              'name': hotel_name,
                              'date': checkin_date,
                              'url': url,
                              'room': best['name'],
                              'smoke': best['smoke'],
                              'price': best['price'],
                              'details': valid_rooms
                          })
                      else:
                          print(f'      ğŸ˜´ æ— ç¬¦åˆç­›é€‰æ¡ä»¶çš„æˆ¿æº')
                      
                      # åªè¦æˆåŠŸè§£æäº† JSONï¼ˆæ— è®ºæœ‰æˆ¿æ²¡æˆ¿ï¼‰ï¼Œå°±è·³å‡ºé‡è¯•å¾ªç¯
                      break
                  
                  except Exception as e:
                      print(f'      âŒ è¯·æ±‚å‡ºé”™: {e} (å°è¯• {attempt+1}/{max_retries})')
                      time.sleep(5)
              
              if not success:
                  print('      ğŸš« å¤šæ¬¡å°è¯•å¤±è´¥ï¼Œæ”¾å¼ƒè¯¥ä»»åŠ¡')

              print('-'*40)
              time.sleep(2)

          # === å‘é€é‚®ä»¶ ===
          if found_list:
              print(f'\nğŸ“§ å‘ç° {len(found_list)} ä¸ªç›®æ ‡ï¼Œå‘é€é‚®ä»¶...')
              if not user_email or not resend.api_key:
                  print('âŒ é‚®ç®±é…ç½®ç¼ºå¤±')
              else:
                  try:
                      first = found_list[0]
                      f_name = first['name']
                      f_date = first['date']
                      f_room = first['room']
                      subject_txt = f'ã€æœ‰æˆ¿ã€‘{f_name} {f_date} {f_room}'
                      
                      html = '<h3>ğŸ‰ å‘ç°ç¬¦åˆç­›é€‰æ¡ä»¶çš„ç©ºæˆ¿ï¼š</h3>'
                      for item in found_list:
                          i_name = item['name']
                          i_date = item['date']
                          i_price = item['price']
                          i_url = item['url']
                          
                          html += f'<hr><h4>ğŸ¨ {i_name} ({i_date})</h4>'
                          html += f'<p><strong>æœ€ä½ä»·:</strong> <span style="color:red">Â¥{i_price}</span></p>'
                          html += f'<p><a href=\"{i_url}\">ğŸ‘‰ ç‚¹å‡»ç«‹å³é¢„è®¢</a></p>'
                          html += '<ul>'
                          deduplicated = {}
                          for d in item['details']:
                              d_name = d['name']
                              d_smoke = d['smoke']
                              d_price = d['price']
                              d_stock = d['stock']
                              
                              key = f'{d_name}-{d_smoke}-{d_price}'
                              if key not in deduplicated:
                                  deduplicated[key] = d
                                  html += f'<li>{d_name} ({d_smoke}): <strong>Â¥{d_price}</strong> (å‰©{d_stock}é—´)</li>'
                          html += '</ul>'
                  
                      resend.Emails.send({'from': 'onboarding@resend.dev', 'to': user_email, 'subject': subject_txt, 'html': html})
                      print('âœ… é‚®ä»¶å‘é€æˆåŠŸï¼')
                  except Exception as e:
                      print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}')
                      traceback.print_exc()
          else:
              print('\nğŸ ç›‘æ§ç»“æŸã€‚')
          "
