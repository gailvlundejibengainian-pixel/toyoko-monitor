name: ä¸œæ¨ªInn ç›‘æ§ (v22.1 ä¿®å¤é‚®ä»¶é…ç½®ç‰ˆ)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      - name: ç”Ÿæˆå¹¶è¿è¡Œè„šæœ¬
        # ğŸ”¥ ä¿®å¤ç‚¹ï¼šå°±æ˜¯è¿™é‡Œï¼åŠ ä¸Š env æ‰èƒ½è¯»å–åˆ°æ‚¨çš„å¯†é’¥
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          # å°† Python ä»£ç å†™å…¥æ–‡ä»¶ monitor.pyï¼Œå½»åº•é¿å… Shell è¯­æ³•æŠ¥é”™
          cat << 'EOF' > monitor.py
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs, unquote
          import re
          import traceback
          from datetime import datetime, timedelta, timezone

          # === 1. å·¥ä½œæ—¶é—´æ§åˆ¶ (run_time.txt) ===
          try:
              # è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
              tz_beijing = timezone(timedelta(hours=8))
              now = datetime.now(tz_beijing)
              current_hour = now.hour
              
              if os.path.exists('run_time.txt'):
                  with open('run_time.txt', 'r') as f:
                      content = f.read().strip()
                      # æ ¼å¼ç¤ºä¾‹: 07-23 (ä»£è¡¨æ—©ä¸Š7ç‚¹åˆ°æ™šä¸Š11ç‚¹è¿è¡Œ)
                      if '-' in content:
                          start_str, end_str = content.split('-')
                          s, e = int(start_str), int(end_str)
                          
                          # åˆ¤æ–­é€»è¾‘: æ”¯æŒè·¨å¤œ (å¦‚ 23-06) å’Œ ç™½å¤© (07-23)
                          is_running = (s <= current_hour <= e) if s <= e else (current_hour >= s or current_hour <= e)
                          
                          if not is_running:
                              print(f'ğŸ’¤ å½“å‰åŒ—äº¬æ—¶é—´ {now.strftime("%H:%M")}ï¼Œä¸åœ¨è®¾å®šè¿è¡Œæ—¶é—´ ({s}-{e})ï¼Œè„šæœ¬ä¼‘çœ ã€‚')
                              exit(0)
                          else:
                              print(f'âœ… å½“å‰åŒ—äº¬æ—¶é—´ {now.strftime("%H:%M")}ï¼Œå¤„äºå·¥ä½œæ—¶é—´ ({s}-{e})ï¼Œå¼€å§‹å¹²æ´»ã€‚')
          except Exception as e:
              print(f'âš ï¸ æ—¶é—´æ£€æŸ¥å‡ºé”™: {e}ï¼Œé»˜è®¤ç»§ç»­è¿è¡Œã€‚')

          # === 2. åŸºç¡€é…ç½® ===
          resend.api_key = os.environ.get('RESEND_API_KEY')
          user_email = os.environ.get('USER_EMAIL', '').strip()
          
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept-Language': 'zh-CN,zh;q=0.9', 
          }

          # === 3. è¯»å– URL (æ”¯æŒ # æ³¨é‡Š) ===
          urls = []
          try:
              with open('urls.txt', 'r') as f:
                  for line in f:
                      line = line.strip()
                      # ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½ï¼šè·³è¿‡ç©ºè¡Œï¼Œè·³è¿‡ # å¼€å¤´çš„æ³¨é‡Šè¡Œ
                      if line and not line.startswith('#'):
                          urls.append(line)
          except:
              print('âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'\nğŸ“‹ å¯åŠ¨ç›‘æ§: {len(urls)} ä¸ªä»»åŠ¡ (ç»å…¸æ–‡æœ¬æ¨¡å¼)\n')
          
          found_list = []

          for i, url in enumerate(urls):
              # è§£æ URL å‚æ•°ç”¨äºæ—¥å¿—
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  checkin_date = params.get('start', ['æœªçŸ¥'])[0]
                  
                  # è·å–ä»·æ ¼ä¸Šé™
                  max_price = 999999
                  if 'max' in params:
                      try: max_price = int(params['max'][0])
                      except: pass
                  
                  # è·å–æˆ¿å‹å…³é”®å­— (æ”¯æŒ roomtype=åšçˆ±)
                  target_room = None
                  if 'roomtype' in params:
                      target_room = unquote(params['roomtype'][0])
              except:
                  hotel_id, checkin_date = 'æœªçŸ¥', 'æœªçŸ¥'
                  max_price = 999999
                  target_room = None

              filter_info = []
              if max_price < 999999: filter_info.append(f'<{max_price}')
              if target_room: filter_info.append(f'[{target_room}]')
              
              print(f'[{i+1}/{len(urls)}] ğŸ¨ {hotel_id} | ğŸ“… {checkin_date} | {", ".join(filter_info) or "æ— ç­›é€‰"}')

              try:
                  resp = requests.get(url, headers=headers, timeout=30)
                  
                  # ç®€å•ç»´æŠ¤æ£€æµ‹
                  if 'ç³»ç»Ÿç»´æŠ¤' in resp.text:
                      print('      ğŸš§ å®˜ç½‘ç³»ç»Ÿç»´æŠ¤ä¸­')
                      print('-'*40)
                      continue

                  soup = BeautifulSoup(resp.text, 'html.parser')
                  
                  # === 4. æ‰‹æœ¯åˆ€å»å™ª (é˜²æ­¢æŠ“åˆ°é¡µè„š 7600) ===
                  # åˆ æ‰è„šæœ¬ã€æ ·å¼ã€å¤´å°¾å¯¼èˆªã€åº•éƒ¨é“¾æ¥
                  for trash in soup(['script', 'style', 'noscript', 'iframe', 'header', 'footer', 'nav']):
                      trash.decompose()
                  for div in soup.find_all('div', class_=re.compile(r'footer|header|banner|advert')):
                      div.decompose()

                  # === 5. æ–‡æœ¬å®šä½ ===
                  # å¦‚æœæŒ‡å®šäº†æˆ¿å‹å…³é”®å­—ï¼Œæˆ‘ä»¬åªçœ‹åŒ…å«è¿™ä¸ªå…³é”®å­—çš„â€œé‚£ä¸€æ®µâ€æ–‡å­—
                  if target_room:
                      targets = soup.find_all(string=re.compile(target_room))
                      if not targets:
                          print(f'      âš ï¸ é¡µé¢ä¸­æœªæ‰¾åˆ°æˆ¿å‹å…³é”®å­—: "{target_room}" (å¯èƒ½æ— æˆ¿æˆ–ä¸æ˜¾ç¤º)')
                          clean_text = "" # æ¸…ç©ºå†…å®¹ï¼Œå¼ºåˆ¶åˆ¤å®šä¸ºæ— æˆ¿
                      else:
                          # æ‰¾åˆ°äº†å…³é”®å­—ï¼ŒæŠŠå®ƒä»¬å‘¨å›´çš„å†…å®¹æ‹¼èµ·æ¥æ£€æŸ¥
                          scope_text = ""
                          for t in targets:
                              parent = t.parent
                              # å‘ä¸Šæ‰¾5å±‚ï¼Œè¶³ä»¥åŒ…å«ä»·æ ¼æ ‡ç­¾
                              for _ in range(5):
                                  if parent and parent.parent: parent = parent.parent
                              if parent:
                                  scope_text += parent.get_text() + "\n"
                          clean_text = scope_text
                  else:
                      # æ²¡æŒ‡å®šæˆ¿å‹ï¼Œçœ‹å…¨æ–‡
                      clean_text = soup.get_text()

                  # === 6. æå–ä»·æ ¼å’Œåº“å­˜ ===
                  valid_prices = []
                  # æ­£åˆ™æ‰¾ä»·æ ¼ Â¥ 12,345
                  raw_prices = re.findall(r'Â¥\s*([0-9,]+)', clean_text)
                  for p in raw_prices:
                      try:
                          v = int(p.replace(',', ''))
                          # è¿‡æ»¤æ‰ 10000(å ä½ç¬¦) å’Œ 4000ä»¥ä¸‹(æ‚è´¹/VODè´¹)
                          if v != 10000 and v > 4000: 
                              valid_prices.append(v)
                      except: pass
                  
                  # æ­£åˆ™æ‰¾åº“å­˜ (å‰© 1 é—´)
                  has_stock = re.search(r'å‰©\s*(\d+)\s*é—´', clean_text)

                  # === 7. åˆ¤å®šé€»è¾‘ ===
                  real_min_price = min(valid_prices) if valid_prices else 999999
                  is_found = False
                  
                  # åªè¦æŠ“åˆ°äº†æœ‰æ•ˆä»·æ ¼ï¼Œä¸”åœ¨é¢„ç®—å†…
                  if valid_prices and real_min_price <= max_price:
                      is_found = True
                      print(f'      ğŸ‰ å‘ç°ä»·æ ¼! æœ€ä½ Â¥{real_min_price}')
                  
                  # æˆ–è€…æ²¡æŠ“åˆ°ä»·æ ¼ä½†æœ‰åº“å­˜æç¤º (å…œåº•)
                  elif has_stock:
                      is_found = True
                      print(f'      ğŸ‰ å‘ç°åº“å­˜! {has_stock.group()}')
                  
                  else:
                      if valid_prices:
                          print(f'      ğŸ’¸ æœ‰æˆ¿ä½†å¤ªè´µ (æœ€ä½ Â¥{real_min_price})')
                      else:
                          print('      ğŸ˜´ æš‚æ— ç©ºæˆ¿ (æˆ–æœªåŒ¹é…åˆ°æˆ¿å‹)')

                  if is_found:
                      # å°è¯•è·å–é…’åº—å
                      hotel_name = f'é…’åº—{hotel_id}'
                      try: 
                          h1 = soup.find('h1')
                          if h1: hotel_name = h1.get_text(strip=True)
                      except: pass

                      found_list.append({
                          'name': hotel_name,
                          'date': checkin_date,
                          'price': real_min_price if real_min_price < 999999 else 'æœ‰ç©ºæˆ¿',
                          'url': url,
                          'room': target_room if target_room else 'ä»»æ„æˆ¿å‹'
                      })
                  
                  time.sleep(2)

              except Exception as e:
                  print(f'      âŒ å‡ºé”™: {e}')
              print('-'*40)

          # === 8. å‘é€é‚®ä»¶ ===
          if found_list:
              print(f'\nğŸ“§ å‘ç° {len(found_list)} ä¸ªç›®æ ‡ï¼Œå‘é€é‚®ä»¶...')
              if user_email and resend.api_key:
                  try:
                      first = found_list[0]
                      subj = f"ã€æœ‰æˆ¿ã€‘{first['name']} {first['date']} Â¥{first['price']}"
                      body = "<h3>ğŸ‰ å‘ç°ç¬¦åˆæ¡ä»¶çš„ç©ºæˆ¿ï¼š</h3>"
                      for item in found_list:
                          body += f"<hr><p><strong>{item['name']}</strong><br>æ—¥æœŸ: {item['date']}<br>ç­›é€‰æˆ¿å‹: {item['room']}<br>æœ€ä½ä»·: <span style='color:red'>Â¥{item['price']}</span><br><a href='{item['url']}'>ğŸ‘‰ ç‚¹å‡»ç«‹å³é¢„è®¢</a></p>"
                      
                      resend.Emails.send({'from': 'onboarding@resend.dev', 'to': user_email, 'subject': subj, 'html': body})
                      print('âœ… é‚®ä»¶å‘é€æˆåŠŸï¼')
                  except Exception as e:
                      print(f'âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}')
              else:
                  print('âŒ é‚®ç®±æœªé…ç½®')
          else:
              print('\nğŸ ç›‘æ§ç»“æŸï¼Œæ— ç¬¦åˆæ¡ä»¶æˆ¿æºã€‚')
          EOF
          
          # è¿è¡Œ Python è„šæœ¬ (ä½¿ç”¨ -u å‚æ•°ä¿è¯æ—¥å¿—å®æ—¶è¾“å‡º)
          python -u monitor.py
