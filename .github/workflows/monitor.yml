name: ä¸œæ¨ªInn ç›‘æ§ (v21.0 å®Œç¾é€‚é…ç‰ˆ)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      - name: ç”Ÿæˆå¹¶è¿è¡Œè„šæœ¬
        run: |
          cat << 'EOF' > monitor.py
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs, unquote
          import json
          import traceback
          from datetime import datetime, timedelta, timezone

          # === 0. æ—¶é—´æ§åˆ¶å™¨ (åŒ—äº¬æ—¶é—´) ===
          try:
              tz_beijing = timezone(timedelta(hours=8))
              now = datetime.now(tz_beijing)
              if os.path.exists('run_time.txt'):
                  with open('run_time.txt', 'r') as f:
                      content = f.read().strip()
                      if '-' in content:
                          s, e = map(int, content.split('-'))
                          h = now.hour
                          is_run = (s <= h <= e) if s <= e else (h >= s or h <= e)
                          if not is_run:
                              print(f'ğŸ’¤ ä¼‘çœ æ—¶é—´ ({s}-{e})ï¼Œå½“å‰ {h} ç‚¹ã€‚')
                              exit(0)
          except: pass

          # === é…ç½®åŒº ===
          resend.api_key = os.environ.get('RESEND_API_KEY')
          user_email = os.environ.get('USER_EMAIL', '').strip()
          
          # ä¼ªè£…æˆæµè§ˆå™¨
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
              'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
              'Referer': 'https://www.toyoko-inn.com/china_cn/',
              'Connection': 'keep-alive',
          }

          urls = []
          try:
              with open('urls.txt', 'r') as f:
                  for line in f:
                      line = line.strip()
                      if line and not line.startswith('#'):
                          urls.append(line)
          except:
              print('âŒ æ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'\nğŸ“‹ å¯åŠ¨ç›‘æ§: {len(urls)} ä¸ªä»»åŠ¡ (v21.0 å®Œç¾é€‚é…ç‰ˆ)\n')
          
          session = requests.Session()
          session.headers.update(headers)

          # å…ˆè®¿é—®é¦–é¡µæ‹¿ Cookies
          try:
              print('ğŸš€ æ­£åœ¨è·å–é€šè¡Œè¯ (Cookies)...')
              session.get('https://www.toyoko-inn.com/china_cn/', timeout=10)
              print('âœ… è·å–æˆåŠŸï¼Œå¼€å§‹æŸ¥è¯¢ã€‚\n')
          except:
              print('âš ï¸ é¦–é¡µè®¿é—®å¤±è´¥ï¼Œç›´æ¥å°è¯•æœç´¢ã€‚\n')

          found_list = []

          for i, url in enumerate(urls):
              # === 1. æ™ºèƒ½å‚æ•°è§£æ ===
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  checkin_date = params.get('start', ['æœªçŸ¥'])[0]
                  
                  # ä»·æ ¼ä¸Šé™
                  max_price = 999999
                  if 'max' in params:
                      try: max_price = int(params['max'][0])
                      except: pass
                  
                  # æˆ¿å‹å…³é”®å­—
                  target_room = None
                  if 'roomtype' in params: target_room = unquote(params['roomtype'][0])
                  
                  # å¸çƒŸ/ç¦çƒŸç­›é€‰ (å…¼å®¹ å®˜ç½‘å‚æ•° å’Œ è‡ªå®šä¹‰å‚æ•°)
                  target_smoke = None 
                  
                  # ä¼˜å…ˆçœ‹å®˜ç½‘åŸç”Ÿå‚æ•° smoking=smoking/non_smoking
                  if 'smoking' in params:
                      val = params['smoking'][0]
                      if val == 'smoking': target_smoke = True
                      elif val == 'non_smoking': target_smoke = False
                  
                  # å†çœ‹è‡ªå®šä¹‰å‚æ•° smoke=1/0 (å¦‚æœæœ‰ï¼Œè¦†ç›–å‰é¢çš„)
                  if 'smoke' in params:
                      val = params['smoke'][0]
                      if val == '1': target_smoke = True
                      elif val == '0': target_smoke = False

              except:
                  hotel_id, checkin_date = 'æœªçŸ¥', 'æœªçŸ¥'
                  max_price = 999999
                  target_room, target_smoke = None, None

              # æ‰“å°ç­›é€‰æ¡ä»¶
              info = []
              if max_price < 999999: info.append(f'<{max_price}')
              if target_room: info.append(f'[{target_room}]')
              if target_smoke is True: info.append('[å¸çƒŸ]')
              elif target_smoke is False: info.append('[ç¦çƒŸ]')
              
              print(f'[{i+1}/{len(urls)}] ğŸ¨ {hotel_id} | ğŸ“… {checkin_date} | {", ".join(info) or "æ— ç­›é€‰"}')

              # === 2. æŠ“å–ä¸åˆ†æ ===
              for attempt in range(2):
                  try:
                      resp = session.get(url, timeout=30)
                      
                      # ç»´æŠ¤/è¢«æ‹¦æˆªæ£€æµ‹
                      if '__NEXT_DATA__' not in resp.text:
                          if 'ç»´æŠ¤' in resp.text: print(f'      ğŸš§ ç³»ç»Ÿç»´æŠ¤ä¸­')
                          else: print(f'      âš ï¸ æ— æ•°æ® (å¯èƒ½è¢«æ‹¦æˆª)')
                          time.sleep(3)
                          continue

                      soup = BeautifulSoup(resp.text, 'html.parser')
                      script = soup.find('script', id='__NEXT_DATA__')
                      data = json.loads(script.string)
                      page_props = data.get('props', {}).get('pageProps', {})
                      room_plan_list = page_props.get('roomPlanList', [])
                      if room_plan_list is None: room_plan_list = []

                      # è·å–é…’åº—å
                      hotel_name = f'é…’åº—{hotel_id}'
                      try: hotel_name = page_props['hotel']['hotelName']
                      except: pass
                      
                      # ç»Ÿè®¡è¯¥é¡µé¢åˆ°åº•æ‰¾åˆ°äº†å¤šå°‘ä¸ªå¥—é¤
                      total_plans = len(room_plan_list)
                      if total_plans == 0:
                          print('      ğŸ˜´ å®˜ç½‘è¿”å›ç©ºåˆ—è¡¨ (è¯¥æ¡ä»¶æ— æˆ¿)')
                          break # ç¡®å®æ²¡æˆ¿ï¼Œä¸ç”¨é‡è¯•

                      valid_rooms = []
                      
                      for plan in room_plan_list:
                          room_types = plan.get('roomTypes', [])
                          for room in room_types:
                              r_name = room.get('roomTypeName', '')
                              specs = room.get('specs', {})
                              is_smoking = specs.get('isSmoking', False)
                              
                              vacant = room.get('vacant', {})
                              stock = vacant.get('generalVacantRoom', 0)
                              if stock is None: stock = 0
                              
                              price_obj = room.get('price', {})
                              price = price_obj.get('generalPrice', 999999)
                              
                              # --- ä¸¥æ ¼ç­›é€‰é€»è¾‘ ---
                              reject = None
                              if stock <= 0: reject = 'æ— åº“å­˜'
                              elif price > max_price: reject = 'è¶…é¢„ç®—'
                              elif target_room and target_room not in r_name: reject = 'æˆ¿å‹ä¸ç¬¦'
                              elif target_smoke is not None and target_smoke != is_smoking: reject = 'çƒŸå‘³ä¸ç¬¦'

                              if not reject:
                                  smoke_str = 'å¸çƒŸ' if is_smoking else 'ç¦çƒŸ'
                                  # print(f'      âœ… åŒ¹é…: {r_name}({smoke_str}) Â¥{price}')
                                  valid_rooms.append({
                                      'name': r_name,
                                      'smoke': smoke_str,
                                      'price': price,
                                      'stock': stock,
                                      'plan': plan.get('planName', 'æ ‡å‡†')
                                  })

                      if valid_rooms:
                          best = min(valid_rooms, key=lambda x: x['price'])
                          print(f"      ğŸ‰ å‘ç°ç›®æ ‡! {best['name']}({best['smoke']}) Â¥{best['price']}")
                          
                          found_list.append({
                              'name': hotel_name,
                              'date': checkin_date,
                              'url': url,
                              'room': best['name'],
                              'smoke': best['smoke'],
                              'price': best['price'],
                              'details': valid_rooms
                          })
                          break 
                      else:
                          # æ‰¾åˆ°äº†å¥—é¤ä½†éƒ½è¢«ç­›é€‰æ‰äº†
                          print(f'      ğŸ˜´ {total_plans}ä¸ªå¥—é¤å‡ä¸ç¬¦åˆç­›é€‰æ¡ä»¶')
                          break

                  except Exception as e:
                      print(f'      âŒ é”™è¯¯: {e}')
                      time.sleep(3)
              
              print('-'*40)
              time.sleep(2)

          # === å‘é€é‚®ä»¶ ===
          if found_list:
              print(f'\nğŸ“§ å‘é€é‚®ä»¶ ({len(found_list)}ä¸ªç›®æ ‡)...')
              if user_email and resend.api_key:
                  try:
                      first = found_list[0]
                      subj = f"ã€æœ‰æˆ¿ã€‘{first['name']} {first['date']} {first['room']}"
                      body = "<h3>ğŸ‰ å‘ç°ç›®æ ‡ï¼š</h3>"
                      for item in found_list:
                          body += f"<hr><h4>{item['name']} ({item['date']})</h4>"
                          body += f"<p>æœ€ä½: <span style='color:red'>Â¥{item['price']}</span></p>"
                          body += f"<p><a href='{item['url']}'>ğŸ‘‰ ç«‹å³é¢„è®¢</a></p><ul>"
                          dedup = set()
                          for d in item['details']:
                              key = f"{d['name']}-{d['smoke']}-{d['price']}"
                              if key not in dedup:
                                  dedup.add(key)
                                  body += f"<li>{d['name']} ({d['smoke']}) Â¥{d['price']} å‰©{d['stock']}</li>"
                          body += "</ul>"
                      
                      resend.Emails.send({'from': 'onboarding@resend.dev', 'to': user_email, 'subject': subj, 'html': body})
                      print('âœ… å‘é€æˆåŠŸ')
                  except Exception as e:
                      print(f'âŒ å‘é€å¤±è´¥: {e}')
              else:
                  print('âŒ é‚®ç®±æœªé…ç½®')
          else:
              print('\nğŸ ç›‘æ§ç»“æŸ')
          EOF
          
          python -u monitor.py
