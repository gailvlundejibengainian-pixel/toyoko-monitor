name: ä¸œæ¨ªInn ç›‘æ§ (v17.0 ç»å…¸å›å½’ç‰ˆ)

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  check_rooms:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests beautifulsoup4 resend

      # ğŸ”¥ æ ¸å¿ƒæ”¹å˜ï¼šå…ˆç”Ÿæˆ py æ–‡ä»¶ï¼Œå†è¿è¡Œã€‚å½»åº•æœç» shell è¯­æ³•æŠ¥é”™ã€‚
      - name: ç”Ÿæˆè„šæœ¬
        run: |
          cat << 'EOF' > monitor.py
          import requests
          from bs4 import BeautifulSoup
          import os
          import resend
          import time
          from urllib.parse import urlparse, parse_qs, unquote
          import re
          import traceback
          from datetime import datetime, timedelta, timezone

          # === 0. æ—¶é—´æ§åˆ¶å™¨ (åŒ—äº¬æ—¶é—´ 7ç‚¹-24ç‚¹è¿è¡Œ) ===
          try:
              tz_beijing = timezone(timedelta(hours=8))
              now = datetime.now(tz_beijing)
              if 0 <= now.hour < 7:
                  print(f'ğŸ’¤ å¤œé—´ä¼‘çœ æ¨¡å¼ (å½“å‰ {now.strftime("%H:%M")})ï¼Œè„šæœ¬è·³è¿‡ã€‚')
                  exit(0)
          except: pass

          # === é…ç½®åŒº ===
          resend.api_key = os.environ.get('RESEND_API_KEY')
          user_email = os.environ.get('USER_EMAIL', '').strip()
          
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          }

          urls = []
          try:
              with open('urls.txt', 'r') as f:
                  for line in f:
                      line = line.strip()
                      if line and not line.startswith('#'):
                          urls.append(line)
          except:
              print('âŒ æ‰¾ä¸åˆ° urls.txt')
              exit(1)

          print(f'\nğŸ“‹ å¯åŠ¨ç›‘æ§: {len(urls)} ä¸ªä»»åŠ¡ (ç»å…¸æ–‡æœ¬æ¨¡å¼)\n')
          
          found_list = []

          for i, url in enumerate(urls):
              try:
                  parsed = urlparse(url)
                  params = parse_qs(parsed.query)
                  hotel_id = params.get('hotel', ['æœªçŸ¥'])[0]
                  checkin_date = params.get('start', ['æœªçŸ¥'])[0]
                  
                  # ä»·æ ¼ä¸Šé™
                  max_price = 999999
                  if 'max' in params:
                      try: max_price = int(params['max'][0])
                      except: pass
                  
                  # æˆ¿å‹å…³é”®å­— (å¦‚: åšçˆ±)
                  target_room = None
                  if 'roomtype' in params:
                      target_room = unquote(params['roomtype'][0])

              except:
                  hotel_id, checkin_date = 'æœªçŸ¥', 'æœªçŸ¥'
                  max_price = 999999
                  target_room = None

              print(f'[{i+1}/{len(urls)}] ğŸ¨ {hotel_id} | ğŸ“… {checkin_date} | <{max_price}')

              try:
                  # æ¨¡æ‹Ÿæµè§ˆå™¨è¯·æ±‚
                  resp = requests.get(url, headers=headers, timeout=30)
                  
                  # ç»´æŠ¤æ£€æµ‹
                  if 'ç³»ç»Ÿç»´æŠ¤' in resp.text or 'maintenance' in resp.text.lower():
                      if 'search' not in url: # ç®€å•çš„è¯¯æŠ¥è¿‡æ»¤
                          print('      ğŸš§ å®˜ç½‘ç³»ç»Ÿç»´æŠ¤ä¸­')
                          continue

                  soup = BeautifulSoup(resp.text, 'html.parser')
                  
                  # === 1. ç‰©ç†å»å™ª (åˆ‡é™¤å¤´å°¾ï¼Œé˜²æ­¢ 7600) ===
                  for trash in soup(['script', 'style', 'noscript', 'iframe', 'header', 'footer', 'nav']):
                      trash.decompose()
                  for div in soup.find_all('div', class_=re.compile(r'footer|header|banner|advert')):
                      div.decompose()

                  # === 2. æ–‡æœ¬é”å®š ===
                  # å¦‚æœæŒ‡å®šäº†æˆ¿å‹(å¦‚ åšçˆ±)ï¼Œæˆ‘ä»¬åªçœ‹åŒ…å«è¿™å‡ ä¸ªå­—çš„é‚£ä¸€å°å—åŒºåŸŸ
                  search_scope = soup
                  
                  if target_room:
                      # æ‰¾åˆ°åŒ…å«å…³é”®å­—çš„æ ‡ç­¾
                      targets = soup.find_all(string=re.compile(target_room))
                      if not targets:
                          # é¡µé¢é‡Œè¿è¿™ä¸ªè¯éƒ½æ²¡å‡ºç° -> è‚¯å®šæ²¡æˆ¿
                          print(f'      âš ï¸ æœªæ‰¾åˆ°æˆ¿å‹: {target_room} (å·²æ»¡æˆ¿æˆ–ä¸æ˜¾ç¤º)')
                          continue
                      
                      # æå–è¿™äº›æ ‡ç­¾çš„çˆ¶çº§å†…å®¹ä½œä¸ºæ£€æŸ¥å¯¹è±¡
                      combined_text = ""
                      for t in targets:
                          # å‘ä¸Šæ‰¾ 5 å±‚çˆ¶çº§ï¼Œç¡®ä¿åŒ…å«ä»·æ ¼
                          parent = t.parent
                          for _ in range(5):
                              if parent and parent.parent: parent = parent.parent
                          if parent:
                              combined_text += parent.get_text() + "\n"
                      
                      clean_text = combined_text
                  else:
                      # æ²¡æŒ‡å®šæˆ¿å‹ï¼Œçœ‹å…¨æ–‡
                      clean_text = soup.get_text()

                  # === 3. æå–ä»·æ ¼ & åº“å­˜ ===
                  # æ‰¾ä»·æ ¼
                  valid_prices = []
                  raw_prices = re.findall(r'Â¥\s*([0-9,]+)', clean_text)
                  for p in raw_prices:
                      try:
                          v = int(p.replace(',', ''))
                          if v != 10000 and v >= 5000: # è¿‡æ»¤æ‚è´¹
                              valid_prices.append(v)
                      except: pass
                  
                  # æ‰¾åº“å­˜ (å‰© X é—´)
                  has_stock = re.search(r'å‰©\s*(\d+)\s*é—´', clean_text)
                  
                  real_min_price = min(valid_prices) if valid_prices else 999999
                  
                  # === 4. åˆ¤å®š ===
                  is_found = False
                  
                  # æƒ…å†µA: æŠ“åˆ°äº†ä»·æ ¼ï¼Œä¸”å°äºé¢„ç®—
                  if valid_prices and real_min_price <= max_price:
                      is_found = True
                      print(f'      ğŸ‰ å‘ç°ä»·æ ¼! æœ€ä½ Â¥{real_min_price}')
                  
                  # æƒ…å†µB: æ²¡æŠ“åˆ°ä»·æ ¼ï¼Œä½†çœ‹åˆ°äº†åº“å­˜æç¤º (å¯èƒ½æ˜¯æ ¼å¼å˜äº†ï¼Œå…ˆæŠ¥è­¦å†è¯´)
                  elif has_stock:
                      is_found = True
                      print(f'      ğŸ‰ å‘ç°åº“å­˜! {has_stock.group()}')
                  
                  else:
                      if valid_prices:
                          print(f'      ğŸ’¸ æœ‰æˆ¿ä½†å¤ªè´µ (æœ€ä½ Â¥{real_min_price})')
                      else:
                          print('      ğŸ˜´ æš‚æ— ç©ºæˆ¿')

                  if is_found:
                      hotel_name = f'é…’åº—{hotel_id}'
                      try:
                          # å°è¯•æŠ“ä¸ªæ ‡é¢˜å½“åå­—
                          h1 = soup.find('h1')
                          if h1: hotel_name = h1.get_text(strip=True)
                      except: pass

                      found_list.append({
                          'name': hotel_name,
                          'date': checkin_date,
                          'price': real_min_price if real_min_price < 999999 else 'æœªçŸ¥',
                          'url': url,
                          'room': target_room if target_room else 'ä»»æ„æˆ¿å‹'
                      })
                      
                  time.sleep(2)

              except Exception as e:
                  print(f'      âŒ å‡ºé”™: {e}')
              print('-'*40)

          # === å‘é€é‚®ä»¶ ===
          if found_list:
              print(f'\nğŸ“§ å‘é€é‚®ä»¶ ({len(found_list)}ä¸ªç›®æ ‡)...')
              if user_email and resend.api_key:
                  try:
                      first = found_list[0]
                      subj = f"ã€æœ‰æˆ¿ã€‘{first['name']} {first['date']} Â¥{first['price']}"
                      body = "<h3>ğŸ‰ å‘ç°ç©ºæˆ¿ï¼š</h3>"
                      for item in found_list:
                          body += f"<hr><p><strong>{item['name']}</strong><br>æ—¥æœŸ: {item['date']}<br>æˆ¿å‹: {item['room']}<br>ä»·æ ¼: Â¥{item['price']}<br><a href='{item['url']}'>ğŸ‘‰ ç«‹å³é¢„è®¢</a></p>"
                      
                      resend.Emails.send({'from': 'onboarding@resend.dev', 'to': user_email, 'subject': subj, 'html': body})
                      print('âœ… é‚®ä»¶å‘é€æˆåŠŸ')
                  except Exception as e:
                      print(f'âŒ å‘é€å¤±è´¥: {e}')
              else:
                  print('âŒ é‚®ç®±æœªé…ç½®')
          else:
              print('\nğŸ ç»“æŸ')
          EOF
          
          python monitor.py
